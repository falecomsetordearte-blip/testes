generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ---------------------------------------------------------
// MODEL DESIGNER
// ---------------------------------------------------------
model DesignerFinanceiro {
  designer_id         Int       @id
  senha_hash          String?
  reset_token         String?   @unique
  reset_token_expires DateTime?
  saldo_disponivel    Decimal   @default(0.00) @db.Decimal(10, 2)
  saldo_pendente      Decimal   @default(0.00) @db.Decimal(10, 2)
  ultimo_saque_em     DateTime?
  criado_em           DateTime  @default(now())
  atualizado_em       DateTime  @updatedAt
  chave_pix           String?
  pontuacao           Int       @default(0)

  @@map("designers_financeiro")
}

// ---------------------------------------------------------
// MODEL EMPRESA
// ---------------------------------------------------------
model Empresa {
  id                           Int      @id @default(autoincrement())
  bitrix_company_id            Int?     @unique
  cnpj                         String   @unique @db.VarChar(18)
  nome_fantasia                String   @db.VarChar(255)
  logo                         String?  @db.Text
  whatsapp                     String?  @db.VarChar(20)
  criado_em                    DateTime @default(now()) @db.Timestamptz(6)
  atualizado_em                DateTime @updatedAt @db.Timestamptz(6)
  
  // Saldos
  saldo_devedor                Decimal  @default(0.00) @db.Decimal(10, 2)
  aprovados                    Decimal  @default(0.00) @db.Decimal(10, 2)

  // Novos campos para a Carteira de Crédito
  credito_aprovado             Boolean  @default(false)
  solicitacao_credito_pendente Boolean  @default(false)
  dados_analise_credito        Json?    // Salva o formulário de solicitação

  // Relacionamentos
  historico_financeiro         HistoricoFinanceiro[]
  produtos                     Produto[] // <--- ADICIONADO: Relação com produtos

  @@map("empresas")
}

// ---------------------------------------------------------
// MODEL HISTÓRICO (Mapeado para historico_financeiro)
// ---------------------------------------------------------
model HistoricoFinanceiro {
  id          Int      @id @default(autoincrement())
  empresa_id  Int
  valor       Decimal  @db.Decimal(10, 2)
  deal_id     String?
  titulo      String?
  data        DateTime @default(now())
  
  // --- NOVOS CAMPOS ADICIONADOS ---
  descricao   String?  // Para texto livre
  tipo        String?  // 'ENTRADA' ou 'SAIDA'
  metadados   String?  // Para salvar o link do Bitrix (usaremos JSON stringify aqui)

  empresa     Empresa  @relation(fields: [empresa_id], references: [id])

  @@map("historico_financeiro")
}

// ---------------------------------------------------------
// MODELOS DE PRODUTOS (NOVO MÓDULO)
// ---------------------------------------------------------

model Produto {
  id             Int      @id @default(autoincrement())
  empresa_id     Int
  nome           String
  prazo_producao String?  // Ex: "2 dias úteis"
  
  // Lógica de Preço
  tipo_calculo   String   @default("UNIDADE") // Opções: 'UNIDADE', 'METRO', 'FIXO', 'FAIXA'
  preco_base     Decimal  @default(0.00) @db.Decimal(10, 2) // Preço unitário ou Preço do m²
  
  // Dimensões (Opcional, para valores padrão)
  largura_padrao Decimal? @db.Decimal(10, 2)
  altura_padrao  Decimal? @db.Decimal(10, 2)

  criado_em      DateTime @default(now())
  atualizado_em  DateTime @updatedAt 

  // Relacionamentos
  empresa        Empresa  @relation(fields: [empresa_id], references: [id])
  variacoes      ProdutoVariacao[]
  faixas_preco   ProdutoPrecoFaixa[] // Para quando for preço por quantidade (atacado)

  @@map("produtos")
}

model ProdutoVariacao {
  id            Int      @id @default(autoincrement())
  produto_id    Int
  nome          String   // Ex: "Acabamento", "Papel", "Cor"
  tipo_selecao  String   @default("UNICA") // 'UNICA' (Radio/Select) ou 'MULTIPLA' (Checkbox)
  
  produto       Produto  @relation(fields: [produto_id], references: [id], onDelete: Cascade)
  opcoes        ProdutoVariacaoOpcao[]

  @@map("produto_variacoes")
}

model ProdutoVariacaoOpcao {
  id              Int             @id @default(autoincrement())
  variacao_id     Int
  nome            String          // Ex: "Fosco", "Couchê 300g"
  preco_adicional Decimal         @default(0.00) @db.Decimal(10, 2) // Quanto soma ao preço base?

  variacao        ProdutoVariacao @relation(fields: [variacao_id], references: [id], onDelete: Cascade)

  @@map("produto_variacao_opcoes")
}

model ProdutoPrecoFaixa {
  id             Int      @id @default(autoincrement())
  produto_id     Int
  minimo         Int      // De: 10 unidades
  maximo         Int?     // Até: 50 unidades (null = infinito)
  valor_unitario Decimal  @db.Decimal(10, 2) // Preço: R$ 5,00 cada

  produto        Produto  @relation(fields: [produto_id], references: [id], onDelete: Cascade)

  @@map("produto_preco_faixas")
}