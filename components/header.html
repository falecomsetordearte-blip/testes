<!-- components/header.html -->
<style>
    /* HEADER VISUAL (O input aqui é só fachada) */
    .app-header {
        background: #fff;
        border-bottom: 1px solid #e2e8f0;
        height: 70px;
        position: sticky;
        top: 0;
        z-index: 900;
        padding: 0 30px;
        display: flex;
        align-items: center;
    }

    .header-content {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* O INPUT FALSO NO HEADER (Serve como botão) */
    .search-trigger-box {
        background: #f1f5f9;
        border-radius: 8px;
        padding: 0 15px;
        height: 45px;
        display: flex;
        align-items: center;
        width: 400px;
        max-width: 100%;
        cursor: text;
        color: #94a3b8;
        border: 1px solid transparent;
        transition: 0.2s;
    }
    .search-trigger-box:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
    }
    .search-trigger-text {
        margin-left: 10px;
        font-size: 0.9rem;
    }

    /* --- O MODAL REAL (SPOTLIGHT STYLE) --- */
    .spotlight-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(15, 23, 42, 0.6); /* Fundo escuro */
        backdrop-filter: blur(4px);
        z-index: 99999; /* GARANTE QUE FIQUE ACIMA DE TUDO */
        display: none;
        justify-content: center;
        align-items: flex-start;
        padding-top: 10vh;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .spotlight-overlay.active {
        display: flex;
        opacity: 1;
    }

    .spotlight-container {
        width: 600px;
        max-width: 90%;
        background: white;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.2s ease;
    }

    .spotlight-overlay.active .spotlight-container {
        transform: scale(1);
    }

    /* Input Real dentro do Modal */
    .spotlight-header {
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
    }
    
    .spotlight-input {
        width: 100%;
        font-size: 1.2rem;
        border: none;
        outline: none;
        color: #334155;
        margin-left: 15px;
    }

    .spotlight-results {
        max-height: 60vh;
        overflow-y: auto;
        padding: 0;
    }

    .spotlight-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f8fafc;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.1s;
    }
    .spotlight-item:hover { background: #f1f5f9; }
    
    .sp-left h4 { margin: 0; font-size: 1rem; color: #1e293b; font-weight: 600; }
    .sp-left p { margin: 2px 0 0; font-size: 0.85rem; color: #64748b; }
    
    .sp-badge {
        font-size: 0.75rem; font-weight: 700; color: white;
        padding: 4px 10px; border-radius: 4px; text-transform: uppercase;
    }

    .spotlight-footer {
        background: #f8fafc;
        padding: 10px 20px;
        font-size: 0.75rem;
        color: #94a3b8;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
    }

    /* User Menu */
    .user-menu { display: flex; gap: 15px; align-items: center; }
    #logout-button { background: none; border: 1px solid #cbd5e1; padding: 5px 15px; border-radius: 6px; cursor: pointer; }

    /* Spinner */
    .sp-spinner { width: 20px; height: 20px; border: 2px solid #ddd; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

</style>

<header class="app-header">
    <div class="header-content">
        <div class="logo-area" style="width: 20px;"></div>
        
        <!-- GATILHO DA BUSCA (Apenas visual) -->
        <div class="search-trigger-box" onclick="abrirBuscaGlobal()">
            <i class="fas fa-search"></i>
            <span class="search-trigger-text">Pesquisar pedido... (Ctrl + K)</span>
        </div>

        <div class="user-menu">
            <span id="user-greeting">Olá!</span>
            <button id="logout-button">Sair</button>
        </div>
    </div>
</header>

<!-- O MODAL QUE VAI FICAR POR CIMA DE TUDO -->
<div id="spotlight-overlay" class="spotlight-overlay" onclick="fecharBuscaGlobal(event)">
    <div class="spotlight-container">
        <div class="spotlight-header">
            <i class="fas fa-search" style="color: #94a3b8; font-size: 1.2rem;"></i>
            <input type="text" id="spotlight-input" class="spotlight-input" placeholder="Digite o número, cliente ou título..." autocomplete="off">
            <div id="spotlight-spinner" class="sp-spinner"></div>
        </div>
        
        <div id="spotlight-results" class="spotlight-results">
            <!-- Resultados aparecem aqui -->
            <div style="padding:40px; text-align:center; color:#cbd5e1;">
                Digite para buscar em todo o sistema
            </div>
        </div>

        <div class="spotlight-footer">
            <span>Use as setas para navegar</span>
            <span>ESC para fechar</span>
        </div>
    </div>
</div>

<script>
    // Funções globais para abrir/fechar
    window.abrirBuscaGlobal = function() {
        const overlay = document.getElementById('spotlight-overlay');
        const input = document.getElementById('spotlight-input');
        overlay.classList.add('active');
        setTimeout(() => input.focus(), 100); // Foca no input
    };

    window.fecharBuscaGlobal = function(e) {
        // Se clicar no overlay (parte escura) ou chamar via ESC
        if (!e || e.target.id === 'spotlight-overlay') {
            document.getElementById('spotlight-overlay').classList.remove('active');
            document.getElementById('spotlight-input').value = '';
            document.getElementById('spotlight-results').innerHTML = '<div style="padding:40px; text-align:center; color:#cbd5e1;">Digite para buscar...</div>';
        }
    };

    document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById('spotlight-input');
        const resultsDiv = document.getElementById('spotlight-results');
        const spinner = document.getElementById('spotlight-spinner');
        let debounceTimeout = null;

        // Atalho de Teclado (Ctrl+K)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                window.abrirBuscaGlobal();
            }
            if (e.key === 'Escape') {
                window.fecharBuscaGlobal({ target: { id: 'spotlight-overlay' } });
            }
        });

        // Evento de Input
        input.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(debounceTimeout);

            if (query.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:40px; text-align:center; color:#cbd5e1;">Digite para buscar...</div>';
                spinner.style.display = 'none';
                return;
            }

            spinner.style.display = 'block';

            debounceTimeout = setTimeout(async () => {
                try {
                    const sessionToken = localStorage.getItem('sessionToken');
                    const res = await fetch('/api/searchDeal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionToken, query })
                    });
                    const data = await res.json();
                    renderResults(data.results);
                } catch (err) {
                    resultsDiv.innerHTML = '<div style="padding:20px; color:red; text-align:center">Erro ao buscar</div>';
                } finally {
                    spinner.style.display = 'none';
                }
            }, 500);
        });

        function renderResults(list) {
            resultsDiv.innerHTML = '';
            if (!list || list.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">Nenhum resultado encontrado.</div>';
                return;
            }

            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'spotlight-item';
                
                const valor = item.valor ? parseFloat(item.valor).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) : '';
                const dataCriacao = new Date(item.data).toLocaleDateString('pt-BR');

                div.innerHTML = `
                    <div class="sp-left">
                        <h4>#${item.id} - ${item.titulo}</h4>
                        <p>${dataCriacao} • ${valor}</p>
                    </div>
                    <div class="sp-right">
                        <span class="sp-badge" style="background-color: ${item.cor_setor}">${item.setor}</span>
                    </div>
                `;
                
                div.onclick = () => {
                    // Lógica de Redirecionamento Inteligente
                    window.fecharBuscaGlobal({ target: { id: 'spotlight-overlay' } });
                    
                    // Exemplo: Se for ARTE, vai pro painel de arte, se for CRM vai pro CRM
                    if(item.setor.includes('CRM')) window.location.href = '/crm.html';
                    else if(item.setor.includes('ARTE')) window.location.href = '/painel.html';
                    else if(item.setor.includes('ACABAMENTO')) window.location.href = '/acabamento/acabamento.html';
                    else if(item.setor.includes('EXPEDIÇÃO')) window.location.href = '/expedicao/index.html';
                    else alert('Pedido #' + item.id + ' selecionado!');
                };

                resultsDiv.appendChild(div);
            });
        }
        
        // Logout
        const btnLogout = document.getElementById('logout-button');
        if(btnLogout) btnLogout.onclick = () => {
            localStorage.removeItem('sessionToken');
            window.location.href = '/login.html';
        };
    });
</script>